Import-Module activedirectory

cd (split-path $MyInvocation.InvocationName -Parent)

$CSV = "Neue Attribute Benutezr AD.csv"

if((Get-FileEncoding $csv) -ne "UTF8"){Set-Content $Csv -Value (Get-Content $csv) -Encoding UTF8}

$Users = Import-Csv -Path $CSV -Delimiter ";" 

$ADUsers = Get-ADUser -SearchBase "OU=vblusers2,DC=vbl,DC=ch" -filter * -properties extensionattribute1, extensionattribute2, Title, Manager, department, displayname

$ADGroupMembers = Get-ADGroupMember "F_Mitarbeiter ohne Arbeitsplatz" -Recursive
$Departments = "Dienste","Fahrdienst Teamleitung","Kundenberatung"

$Users | %{

    $User = $_
    $ADUser = ($ADUsers | where{$_.extensionattribute1 -eq $User.Nr})
    
    if((($ADGroupMembers | %{$_.Name}) -contains $ADUser.Name) -and ($Departments -contains $ADUser.department)){
                
        $(New-Object PSObject -Property @{
            Name = $ADuser.Name
            Title = $ADUser.Title
            department = $ADUser.department
            Action = "Remove from ADGroup"
        })
        
     }elseif(($ADGroupMembers | %{$_.Name}) -notcontains $ADUser.Name){
     
         $(New-Object PSObject -Property @{
            Name = $ADuser.Name
            Title = $ADUser.Title
            department = $ADUser.department
            Action = "Add to ADGroup"
        })
     
     }
    
} | Out-GridView
